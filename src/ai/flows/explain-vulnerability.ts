'use server';

/**
 * @fileOverview This file defines a Genkit flow for explaining smart contract vulnerabilities in plain English.
 *
 * The flow takes in a raw vulnerability report from a static analysis tool and uses AI to generate a human-readable explanation,
 * including the risk impact and suggested fixes.
 *
 * - explainVulnerability - The main function that triggers the vulnerability explanation flow.
 * - ExplainVulnerabilityInput - The input type for the explainVulnerability function.
 * - ExplainVulnerabilityOutput - The output type for the explainVulnerability function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const ExplainVulnerabilityInputSchema = z.object({
  vulnerabilityReport: z
    .string()
    .describe(
      'The raw vulnerability report from a static analysis tool (e.g., Slither).'
    ),
  sourceCode: z.string().describe('The source code of the smart contract.'),
});
export type ExplainVulnerabilityInput = z.infer<typeof ExplainVulnerabilityInputSchema>;

const ExplainVulnerabilityOutputSchema = z.object({
  explanation: z.string().describe('A plain-English explanation of the vulnerability.'),
  riskImpact: z.string().describe('The potential risk impact of the vulnerability.'),
  suggestedFixes: z.string().describe('Suggested fixes for the vulnerability.'),
});
export type ExplainVulnerabilityOutput = z.infer<typeof ExplainVulnerabilityOutputSchema>;

export async function explainVulnerability(
  input: ExplainVulnerabilityInput
): Promise<ExplainVulnerabilityOutput> {
  return explainVulnerabilityFlow(input);
}

const prompt = ai.definePrompt({
  name: 'explainVulnerabilityPrompt',
  input: {schema: ExplainVulnerabilityInputSchema},
  output: {schema: ExplainVulnerabilityOutputSchema},
  prompt: `You are a security expert specializing in explaining smart contract vulnerabilities to developers with limited security expertise.

You will receive a raw vulnerability report from a static analysis tool and the source code of the contract. Your task is to:

1.  Provide a plain-English explanation of the vulnerability, avoiding jargon as much as possible.
2.  Clearly describe the potential risk impact of the vulnerability, explaining how it could be exploited in real-world attacks.
3.  Suggest specific fixes that the developer can implement to address the vulnerability.

Here is the vulnerability report:
{{vulnerabilityReport}}

Here is the source code:
{{sourceCode}}

Respond with the following format:
Explanation: <plain-english explanation>
Risk Impact: <risk impact>
Suggested Fixes: <suggested fixes>`,
});

const explainVulnerabilityFlow = ai.defineFlow(
  {
    name: 'explainVulnerabilityFlow',
    inputSchema: ExplainVulnerabilityInputSchema,
    outputSchema: ExplainVulnerabilityOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
